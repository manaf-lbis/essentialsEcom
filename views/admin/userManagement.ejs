<!DOCTYPE html>
<html lang="en">

<head>
  <%- include("../partials/htmlHead.ejs",{csspath:"/css/adminCss/usermanagement/usermanagement.css"})%>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
      .user-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }

      .user-table th {
        font-weight: 600;
        color: #64748b;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        padding: 1rem;
      }

      .user-table td {
        vertical-align: middle;
        padding: 1rem;
        border-bottom: 1px solid #f1f5f9;
        color: #334155;
        font-size: 0.9rem;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 99px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        min-width: 80px;
        text-align: center;
      }

      .status-active {
        background-color: #dcfce7;
        color: #15803d;
      }

      .status-blocked {
        background-color: #fef2f2;
        color: #b91c1c;
      }

      .btn-action {
        width: 90px;
        font-size: 0.8rem;
        padding: 0.4rem;
        border-radius: 6px;
        transition: all 0.2s;
      }
    </style>
</head>

<body class="bg-light">

  <%- include('../partials/adminNavbar.ejs')%>

    <div class="container-fluid wrapper">
      <%- include("../partials/adminLeftsidebar.ejs")%>

        <div class="mainpanel p-4">

          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h4 class="fw-bold mb-1">User Management</h4>
              <p class="text-muted small mb-0">Manage customer accounts</p>
            </div>

            <form method="get" action="/admin/usermanagement"
              class="d-flex shadow-sm bg-white rounded-3 overflow-hidden" style="max-width: 300px;">
              <input name="search" class="form-control border-0 shadow-none ps-3" type="search"
                placeholder="Search Users..." value="<%= searchQuery%>" aria-label="Search">
              <button class="btn btn-white border-0 text-primary px-3" type="submit">
                <i class="fas fa-search"></i>
              </button>
            </form>
          </div>

          <div class="user-table mb-4">
            <div class="table-responsive">
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th style="width: 60px;">#</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                    <th class="text-end">Action</th>
                  </tr>
                </thead>
                <tbody>
                  <%if(userData && userData.length> 0) {%>
                    <%userData.forEach((user, index)=> {%>
                      <tr id="row-<%= user._id%>">
                        <td class="text-muted small">
                          <%= (currentPage - 1) * 10 + (index + 1)%>
                        </td>
                        <td>
                          <div class="fw-bold">
                            <%= user.name%>
                          </div>
                        </td>
                        <td>
                          <%= user.email%>
                        </td>
                        <td>
                          <%= user.phone%>
                        </td>
                        <td>
                          <%if(!user.isBlocked){%>
                            <span class="status-badge status-active">Active</span>
                            <%} else {%>
                              <span class="status-badge status-blocked">Blocked</span>
                              <%}%>
                        </td>
                        <td class="text-end">
                          <%if(!user.isBlocked){%>
                            <button onclick="toggleUserStatus('<%= user._id%>', 'block')"
                              class="btn btn-outline-danger btn-action">
                              <i class="fas fa-ban me-1"></i> Block
                            </button>
                            <%} else {%>
                              <button onclick="toggleUserStatus('<%= user._id%>', 'unblock')"
                                class="btn btn-outline-success btn-action">
                                <i class="fas fa-check me-1"></i> Unblock
                              </button>
                              <%}%>
                        </td>
                      </tr>
                      <%})%>
                        <%} else {%>
                          <tr>
                            <td colspan="6" class="text-center py-5 text-muted">No users found.</td>
                          </tr>
                          <%}%>
                </tbody>
              </table>
            </div>
          </div>

          <%if(totalPage> 1) {%>
            <nav aria-label="Page navigation" class="d-flex justify-content-center">
              <ul class="pagination">
                <li class="page-item <%= Number(currentPage) <= 1 ? 'disabled' : ''%>">
                  <a class="page-link"
                    href="/admin/usermanagement/?pageReq=<%= Number(currentPage)-1%>&search=<%= searchQuery%>">Previous</a>
                </li>
                <li class="page-item active">
                  <a class="page-link" href="#">
                    <%= currentPage%>
                  </a>
                </li>
                <li class="page-item <%= Number(currentPage) >= totalPage ? 'disabled' : ''%>">
                  <a class="page-link"
                    href="/admin/usermanagement/?pageReq=<%= Number(currentPage)+1%>&search=<%= searchQuery%>">Next</a>
                </li>
              </ul>
            </nav>
            <%}%>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      async function toggleUserStatus(id, action) {
        const isBlock = action === 'block';
        const url = isBlock ? `/admin/blockUser/${id}` : `/admin/unblockUser/${id}`;
        const confirmText = isBlock ? "Block this user?" : "Unblock this user?";
        const processingText = isBlock ? "Blocking..." : "Unblocking...";

        const result = await Swal.fire({
          title: 'Are you sure?',
          text: confirmText,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: isBlock ? '#d33' : '#10b981',
          confirmButtonText: isBlock ? 'Yes, Block' : 'Yes, Unblock'
        });

        if (result.isConfirmed) {
          try {
            const response = await fetch(url, { method: 'POST' });

            const data = await response.json();

            if (response.ok) {
              Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: data.message,
                showConfirmButton: false,
                timer: 1500
              }).then(() => window.location.reload());
            } else {
              throw new Error(data.message);
            }
          } catch (err) {
            Swal.fire('Error', 'Action failed', 'error');
          }
        }
      }
    </script>
</body>

</html>