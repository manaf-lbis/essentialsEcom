<html lang="en">

<head>
    <link href="https://cdn.jsdelivr.net/npm/@coreui/coreui-pro@5.6.0/dist/css/coreui.min.css" rel="stylesheet"
        integrity="sha384-/ElSMRaKgsWY7yc9is+yGoOmLb0lEnL0i8BqJoNBrejJNHx8+6ZSD0u13ea6fUn3" crossorigin="anonymous">

    <%- include('../../partials/htmlHeadUser.ejs',{csspath:'/css/userCss/purchase/cart.css'})%>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
            integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
            crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body class="d-flex flex-column" style="background-color: #f8f9fa;">

    <%- include('../../partials/userNavbar.ejs')%>

        <div class="profile-container">
            <div class="profile-layout">
                <%- include('../../partials/userprofile/profileLayoutMinimal.ejs', { activePage: 'orders' })%>

                    <main class="profile-content-card border-0 bg-transparent p-0 shadow-none">
                        <div class="mb-4">
                            <h4 class="fw-bold text-dark">My Orders</h4>
                        </div>

                        <%if(orders && orders.length> 0) {%>
                            <%for(let order of orders){%>
                                <div class="card mb-4 border-0 shadow-sm rounded-4 overflow-hidden">
                                    <div
                                        class="card-header bg-white px-4 py-3 border-bottom-0 d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-4">
                                            <div>
                                                <small class="text-uppercase text-muted fw-bold d-block mb-1"
                                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">Order ID</small>
                                                <span class="text-dark fw-bold orderId"
                                                    style="font-family: monospace; font-size: 0.95rem;">
                                                    <%= order.orderId%>
                                                </span>
                                            </div>
                                            <div class="d-none d-md-block border-start h-50 mx-2"></div>
                                            <div>
                                                <small class="text-uppercase text-muted fw-bold d-block mb-1"
                                                    style="font-size: 0.75rem; letter-spacing: 0.5px;">Date
                                                    Placed</small>
                                                <span class="text-dark">
                                                    <%= order.orderDate.toString().substring(4,15)%>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-end d-none d-md-block">
                                            <small class="text-uppercase text-muted fw-bold d-block mb-1"
                                                style="font-size: 0.75rem; letter-spacing: 0.5px;">Ship To</small>
                                            <span class="text-dark fw-medium">
                                                <%= order.address.fullName%>
                                            </span>
                                        </div>
                                    </div>

                                    <div class="card-body p-0">
                                        <%for(let product of order.orderItems){%>
                                            <div class="p-4 border-top border-light mainCard">
                                                <div class="row">
                                                    <div class="col-lg-2 mb-3 mb-lg-0">
                                                        <div
                                                            class="bg-light rounded p-2 text-center h-100 d-flex align-items-center justify-content-center">
                                                            <img src="<%= product.productId.productImage[0]%>"
                                                                class="img-fluid"
                                                                style="max-height: 100px; object-fit: contain;"
                                                                alt="Product">
                                                        </div>
                                                    </div>

                                                    <div class="col-lg-6 mb-3 mb-lg-0">
                                                        <h6 class="fw-bold mb-2 text-dark">
                                                            <%= product.productId.productName.substring(0,60)%>...
                                                        </h6>

                                                        <div class="d-flex flex-wrap gap-3 mb-2 small text-muted">
                                                            <span><strong>Color:</strong>
                                                                <%= product.productId.color%>
                                                            </span>
                                                            <span><strong>Qty:</strong>
                                                                <%= product.quantity%>
                                                            </span>
                                                            <span><strong>Price:</strong> â‚¹<%=
                                                                    product.productId.sellingPrice%></span>
                                                        </div>

                                                        <div class="mb-2">
                                                            <%if(product.status==='Pending' ){%>
                                                                <span class="badge bg-warning text-dark"><i
                                                                        class="fas fa-clock me-1"></i> Order
                                                                    Placed</span>
                                                                <%}else if(product.status==='Processing' ){%>
                                                                    <span class="badge bg-info text-white"><i
                                                                            class="fas fa-cog me-1"></i>
                                                                        Processing</span>
                                                                    <%}else if(product.status==='Shipped' ){%>
                                                                        <span class="badge bg-primary"><i
                                                                                class="fas fa-shipping-fast me-1"></i>
                                                                            Shipped</span>
                                                                        <%} else if(product.status==='Delivered' ){%>
                                                                            <span class="badge bg-success"><i
                                                                                    class="fas fa-check-circle me-1"></i>
                                                                                Delivered</span>
                                                                            <small class="text-muted d-block mt-1">On
                                                                                <%=product?.deliveryDate?.toString().substring(0,16)%>
                                                                            </small>
                                                                            <%} else if(product.status==='Cancelled' ){%>
                                                                                <span class="badge bg-danger"><i
                                                                                        class="fas fa-times me-1"></i>
                                                                                    Cancelled</span>
                                                                                <%} else if(product.status==='Rejected'
                                                                                    ){%>
                                                                                    <span
                                                                                        class="badge bg-danger">Rejected</span>
                                                                                    <%}else
                                                                                        if(product.status==='ReturnRequested'
                                                                                        ){%>
                                                                                        <span
                                                                                            class="badge bg-warning text-dark">Return
                                                                                            Requested</span>
                                                                                        <%} else
                                                                                            if(product.status==='Returned'
                                                                                            ){%>
                                                                                            <span
                                                                                                class="badge bg-secondary">Returned</span>
                                                                                            <%} else
                                                                                                if(product.status==='Pending for Payment'
                                                                                                ){%>
                                                                                                <span
                                                                                                    class="badge bg-danger">Payment
                                                                                                    Failed</span>
                                                                                                <%}%>
                                                        </div>
                                                    </div>

                                                    <div
                                                        class="col-lg-4 d-flex flex-column justify-content-center gap-2">

                                                        <a href="/orderDetailPage/?orderId=<%= order.orderId%>"
                                                            class="btn btn-outline-primary btn-sm w-100">
                                                            View Details
                                                        </a>

                                                        <%if(product.status==='Pending for Payment' ){%>
                                                            <a href="/retryPayment/?orderId=<%= order.orderId%>"
                                                                class="btn btn-danger btn-sm w-100">
                                                                <i class="fas fa-exclamation-circle me-1"></i> Retry
                                                                Payment
                                                            </a>
                                                            <%}%>

                                                                <%if(product.status==='Delivered' &&
                                                                    product.isRated===false){%>
                                                                    <button type="button"
                                                                        class="btn btn-outline-warning btn-sm w-100 ratingBtn"
                                                                        data-bs-toggle="modal"
                                                                        data-bs-target="#exampleModalCenter">
                                                                        <i class="fas fa-star me-1"></i> Rate
                                                                        Product
                                                                    </button>
                                                                    <input class="productId" hidden
                                                                        productId="<%= product.productId._id%>">
                                                                    <%} else if(product.isRated===true){%>
                                                                        <div class="text-center small text-warning">
                                                                            <i class="fas fa-star"></i> You rated:
                                                                            <%= product.rating%>
                                                                        </div>
                                                                        <%}%>

                                                                            <%if((Date.now() - product?.deliveryDate) /
                                                                                (1000 * 60 * 60 * 24) <=7 &&
                                                                                product.status==='Delivered' ){%>
                                                                                <a href="/returnOrder/?orderId=<%= order.orderId%>&productId=<%= product.productId._id%>"
                                                                                    class="btn btn-outline-danger btn-sm w-100 orderReturnBtn">
                                                                                    Return Item
                                                                                </a>
                                                                                <%}%>

                                                                                    <%if(['Pending', 'Processing'
                                                                                        , 'Shipped'
                                                                                        ].includes(product.status)){%>
                                                                                        <a href="/cancelOrder/?orderId=<%= order.orderId%>&productId=<%= product.productId._id%>"
                                                                                            class="cancelOrderBtn">
                                                                                            <button
                                                                                                class="btn btn-outline-danger btn-sm w-100">Cancel
                                                                                                Order</button>
                                                                                        </a>
                                                                                        <%}%>

                                                                                            <%if(product.status==='Delivered'
                                                                                                ){%>
                                                                                                <a href="/invoice/?orderId=<%= order.orderId%>"
                                                                                                    class="btn btn-secondary btn-sm w-100">
                                                                                                    <i
                                                                                                        class="bi bi-download me-1"></i>
                                                                                                    Invoice
                                                                                                </a>
                                                                                                <%}%>

                                                    </div>
                                                </div>
                                            </div>
                                            <%}%>
                                    </div>
                                </div>
                                <%}%>

                                    <nav class="d-flex justify-content-center mt-4">
                                        <ul class="pagination">
                                            <li class="page-item <%= currentpage <= 1 ? 'disabled' : ''%>">
                                                <a class="page-link"
                                                    href="/orders/?currentpage=<%= currentpage-1%>">Previous</a>
                                            </li>
                                            <li class="page-item active"><a class="page-link">
                                                    <%= currentpage%>
                                                </a></li>
                                            <li class="page-item">
                                                <a class="page-link"
                                                    href="/orders/?currentpage=<%= Number(currentpage)+1%>">Next</a>
                                            </li>
                                        </ul>
                                    </nav>

                                    <%} else {%>
                                        <div class="card p-5 text-center">
                                            <div class="mb-3">
                                                <i class="fas fa-shopping-bag fa-3x text-muted opacity-50"></i>
                                            </div>
                                            <h5>No orders yet</h5>
                                            <p class="text-muted">Looks like you haven't placed any orders yet.</p>
                                            <a href="/home" class="btn btn-primary mt-2"
                                                style="max-width: 200px; margin: 0 auto;">Start Shopping</a>
                                        </div>
                                        <%}%>
                    </main>
            </div>
        </div>

        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
            aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Write a Review</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body ">
                        <input type="hidden" id="modalOrderId">
                        <input type="hidden" id="modalProductId">

                        <div class="d-flex flex-column align-items-center">

                            <div class="mb-3">
                                <div id="myRating" data-coreui-size="lg" data-coreui-precision="0.5"
                                    data-coreui-toggle="rating" data-coreui-value="0" data-coreui-max="5"></div>
                            </div>

                            <div class="form-group w-100">
                                <label for="comment" class="form-label fw-bold">Your Review</label>
                                <textarea class="form-control" id="comment" rows="3"
                                    placeholder="What did you like or dislike?"></textarea>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="ratingSubmit" class="btn btn-primary">Submit Review</button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <%- include('../../partials/userFooter.ejs')%>
        </footer>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@coreui/coreui-pro@5.6.0/dist/js/coreui.bundle.min.js"
            integrity="sha384-mLGa1g62d9QzDXVGjvdUasvKUjkIoq7kjvKJsQifgQdr9x+4Ge3SZuGRTHYwvAl/"
            crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="/js/userjs/purchase/orders.js"></script>
</body>

</html>